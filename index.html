<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgreen Monitor | IoT Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #0f172a, #020617);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.5);
            border-radius: 10px;
        }

        .filter-btn-active {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            color: #60a5fa;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }

        .stat-glow {
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Modal Backdrop */
        #password-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .sensor-banner {
            display: none;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Control Button States */
        .btn-active-emerald {
            background: rgba(16, 185, 129, 0.2) !important;
            border-color: rgba(16, 185, 129, 0.5) !important;
            color: #10b981 !important;
            box-shadow: 0 0 20px rgba(16, 185, 129, 0.15);
        }
        .btn-active-amber {
            background: rgba(245, 158, 11, 0.2) !important;
            border-color: rgba(245, 158, 11, 0.5) !important;
            color: #f59e0b !important;
            box-shadow: 0 0 20px rgba(245, 158, 11, 0.15);
        }

        .color-btn-active {
            background: rgba(255, 255, 255, 0.1) !important;
            border-color: rgba(255, 255, 255, 0.5) !important;
            color: #ffffff !important;
            box-shadow: 0 0 15px rgba(255, 255, 255, 0.1);
        }
    </style>
</head>
<body class="text-slate-100 min-h-screen selection:bg-blue-500/30">

    <!-- Sensor Failure Banner -->
    <div id="sensor-fault-banner" class="sensor-banner sticky top-0 z-[60] bg-rose-600 text-white px-6 py-3 shadow-2xl">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div>
                    <span class="font-bold uppercase tracking-widest text-xs">Sensor Fault Detected:</span>
                    <span id="fault-details" class="ml-2 text-sm font-medium opacity-90">Hardware modules returning NULL.</span>
                </div>
            </div>
            <button onclick="document.getElementById('sensor-fault-banner').style.display='none'" class="text-white/60 hover:text-white">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>

    <!-- Unified Authorization Modal -->
    <div id="password-modal">
        <div class="glass-card p-8 rounded-[2rem] w-full max-w-md border border-white/10 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2" id="modal-title">Authorize Command</h3>
            <p id="modal-desc" class="text-slate-400 text-sm mb-6 leading-relaxed">Administrative password required to modify hardware state or cloud records.</p>
            
            <input type="password" id="admin-pass" placeholder="••••••••" 
                class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-all mb-4 font-mono">
            
            <div id="modal-error" class="text-rose-400 text-[10px] font-bold uppercase tracking-widest mb-4 hidden">Invalid Credentials</div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal()" class="py-3 rounded-xl text-xs font-bold bg-slate-800 hover:bg-slate-700 transition-all text-slate-300">Cancel</button>
                <button onclick="handleAuthorizedAction()" class="py-3 rounded-xl text-xs font-bold bg-blue-600 hover:bg-blue-500 transition-all text-white" id="modal-confirm-btn">Execute</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-10">
        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-12 gap-6">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tighter text-white">
                        MICROGREEN <span class="text-emerald-400">MONITOR</span>
                    </h1>
                </div>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
                    <span id="current-project-label" class="text-slate-400 font-medium text-lg italic">Integrated Biosphere Controller</span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3 bg-slate-900/40 p-4 rounded-2xl border border-slate-800/50">
                <div id="status-badge" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-800 text-slate-500 border border-slate-700 transition-colors duration-500">
                    <span class="w-2 h-2 rounded-full bg-slate-600 animate-pulse"></span>
                    Handshaking...
                </div>
                <div id="live-indicator" class="hidden flex items-center gap-2 text-[10px] font-bold text-emerald-400 uppercase tracking-widest">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Real-time Active
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls & Stats -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Hardware Overrides -->
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-6">Hardware Overrides</h3>
                    <div class="grid grid-cols-2 gap-4 mb-6">
                        <button id="fan-toggle" onclick="requestHardwareToggle('fan')" class="flex flex-col items-center gap-3 p-4 rounded-2xl border border-slate-700/50 hover:bg-white/5 transition-all group">
                            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-widest">Fan Module</span>
                            <span id="fan-status-text" class="text-[9px] opacity-50 font-bold">OFFLINE</span>
                        </button>
                        <button id="light-toggle" onclick="requestHardwareToggle('light')" class="flex flex-col items-center gap-3 p-4 rounded-2xl border border-slate-700/50 hover:bg-white/5 transition-all group">
                            <div class="w-10 h-10 rounded-full bg-slate-800 flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path></svg>
                            </div>
                            <span class="text-[10px] font-bold uppercase tracking-widest">Grow Light</span>
                            <span id="light-status-text" class="text-[9px] opacity-50 font-bold">OFFLINE</span>
                        </button>
                    </div>

                    <!-- Light Color Spectrum Control -->
                    <div id="spectrum-panel" class="hidden space-y-4 pt-6 border-t border-slate-800 animate-slideDown">
                        <h4 class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Spectrum Selection</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="requestColorChange('blurple')" data-color="blurple" class="color-select-btn py-2.5 rounded-xl text-[10px] font-bold uppercase border border-slate-700/50 hover:bg-white/5 transition-all">Blurple</button>
                            <button onclick="requestColorChange('white')" data-color="white" class="color-select-btn py-2.5 rounded-xl text-[10px] font-bold uppercase border border-slate-700/50 hover:bg-white/5 transition-all">White</button>
                            <button onclick="requestColorChange('red')" data-color="red" class="color-select-btn py-2.5 rounded-xl text-[10px] font-bold uppercase border border-slate-700/50 hover:bg-white/5 transition-all">Red</button>
                            <button onclick="requestColorChange('blue')" data-color="blue" class="color-select-btn py-2.5 rounded-xl text-[10px] font-bold uppercase border border-slate-700/50 hover:bg-white/5 transition-all">Blue</button>
                        </div>
                    </div>
                </div>

                <!-- Project Selector -->
                <div class="glass-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">Active Batches</h3>
                        <button onclick="requestClearData()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-rose-500/10 border border-rose-500/20 text-rose-500 hover:bg-rose-500/20 hover:border-rose-500/40 active:scale-95 transition-all text-[10px] font-bold uppercase tracking-widest">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Purge
                        </button>
                    </div>
                    <div class="space-y-2 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar" id="project-filter-container">
                        <button onclick="setProjectFilter('all')" data-project="all" class="project-btn project-btn-active w-full text-left px-4 py-3 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">
                            All Active Batches
                        </button>
                    </div>
                </div>

                <!-- Timeline Selector -->
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Time Range</h3>
                    <div class="grid grid-cols-3 gap-2" id="time-filter-container">
                        <button onclick="setTimeFilter('10m')" data-time="10m" class="time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">10m</button>
                        <button onclick="setTimeFilter('1d')" data-time="1d" class="time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">24h</button>
                        <button onclick="setTimeFilter('all')" data-time="all" class="time-btn-active time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">All</button>
                    </div>
                </div>

                <!-- Stats Stack -->
                <div id="stats-grid" class="grid grid-cols-1 gap-4">
                    <div class="glass-card p-6 rounded-3xl animate-pulse-soft flex flex-col items-center justify-center min-h-[140px]">
                        <p class="text-slate-500 text-sm italic">Hardware telemetry sync...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visualization Grid -->
            <div class="lg:col-span-8 space-y-6">
                <!-- Temperature Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-blue-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Temperature history (°C)</h3>
                        <div class="text-right">
                            <div id="temp-stat" class="text-sm font-black text-blue-400">--</div>
                            <div id="temp-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- Humidity Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-emerald-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Humidity Levels (%)</h3>
                        <div class="text-right">
                            <div id="humid-stat" class="text-sm font-black text-emerald-400">--</div>
                            <div id="humid-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="humidChart"></canvas>
                    </div>
                </div>

                <!-- Light Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-amber-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Light Intensity (%)</h3>
                        <div class="text-right">
                            <div id="light-stat" class="text-sm font-black text-amber-400">--</div>
                            <div id="light-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="lightChart"></canvas>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="glass-card rounded-[2rem] flex flex-col h-[250px] overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-800/50 flex justify-between items-center bg-white/2">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Hardware Logic Log</h3>
                        <span id="data-point-count" class="text-[10px] font-mono text-slate-500">0 Points Syncing</span>
                    </div>
                    <div id="log-container" class="flex-grow p-6 space-y-3 font-mono text-[11px] overflow-y-auto custom-scrollbar bg-slate-950/20">
                        <div class="text-slate-600 animate-pulse">Initializing IoT Bridge...</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center">
            <p class="text-slate-600 text-[10px] uppercase tracking-[0.4em]">Integrated Intelligence System &copy; 2024</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnuEebPEA9rY5ILG8F3zRVNzQj9xfxm-Y",
            authDomain: "microgreens-ae75c.firebaseapp.com",
            databaseURL: "https://microgreens-ae75c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "microgreens-ae75c",
            storageBucket: "microgreens-ae75c.firebasestorage.app",
            messagingSenderId: "134579315817",
            appId: "1:134579315817:web:3b5387c5ad92e254496ef8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logsRef = ref(db, 'logs'); 
        const controlRef = ref(db, 'control'); 

        // DOM Selections
        const statusBadge = document.getElementById('status-badge');
        const liveIndicator = document.getElementById('live-indicator');
        const logContainer = document.getElementById('log-container');
        const statsGrid = document.getElementById('stats-grid');
        const dataCountDisplay = document.getElementById('data-point-count');
        const projectContainer = document.getElementById('project-filter-container');
        const passwordModal = document.getElementById('password-modal');
        const adminPassInput = document.getElementById('admin-pass');
        const modalError = document.getElementById('modal-error');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const sensorBanner = document.getElementById('sensor-fault-banner');
        const faultDetails = document.getElementById('fault-details');
        const fanBtn = document.getElementById('fan-toggle');
        const lightBtn = document.getElementById('light-toggle');
        const fanStatusText = document.getElementById('fan-status-text');
        const lightStatusText = document.getElementById('light-status-text');
        const spectrumPanel = document.getElementById('spectrum-panel');

        let currentTimeFilter = 'all';
        let currentProjectFilter = 'all';
        let allRawData = {};
        let allDataPoints = [];
        let uniqueProjects = new Set();
        const cardElements = {};
        let pendingAction = null;
        let hardwareStates = { fan: false, light: false, color: 'white' };

        // Chart Initialization
        function createChart(id, color, label) {
            const ctx = document.getElementById(id).getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, `${color}44`);
            gradient.addColorStop(1, `${color}00`);

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ 
                        label, data: [], borderColor: color, borderWidth: 2.5, 
                        backgroundColor: gradient, fill: true, tension: 0.4, 
                        pointRadius: 0, pointHoverRadius: 5, spanGaps: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { legend: { display: false } },
                    scales: {
                        y: { grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, ticks: { color: '#64748b', font: { size: 10 } } },
                        x: { grid: { display: false }, ticks: { color: '#475569', font: { size: 9 }, autoSkip: true, maxTicksLimit: 6 } }
                    }
                }
            });
        }

        const tempChart = createChart('tempChart', '#3b82f6', 'Temp (°C)');
        const humidChart = createChart('humidChart', '#10b981', 'Humidity (%)');
        const lightChart = createChart('lightChart', '#f59e0b', 'Light (%)');

        // Core UI Event Listeners
        window.setTimeFilter = (filter) => {
            currentTimeFilter = filter;
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.toggle('time-btn-active', btn.dataset.time === filter));
            updateUI();
        };

        window.setProjectFilter = (filter) => {
            currentProjectFilter = filter;
            document.querySelectorAll('.project-btn').forEach(btn => {
                const isActive = btn.dataset.project === filter;
                btn.classList.toggle('project-btn-active', isActive);
                if(isActive) btn.classList.add('bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
                else btn.classList.remove('bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
            });
            updateUI();
        };

        // Authorization Logic
        window.openModal = (title, desc, action) => {
            modalTitle.innerText = title;
            modalDesc.innerText = desc;
            pendingAction = action;
            passwordModal.style.display = 'flex';
            adminPassInput.value = '';
            adminPassInput.focus();
            modalError.classList.add('hidden');
        };

        window.closeModal = () => {
            passwordModal.style.display = 'none';
            pendingAction = null;
        };

        window.requestClearData = () => {
            const label = currentProjectFilter === 'all' ? 'all database records' : `Batch ${currentProjectFilter.split(' | ')[0]}`;
            openModal("Purge Database", `Warning: Admin authorization required to delete ${label}.`, { type: 'purge' });
        };

        window.requestHardwareToggle = (device) => {
            const newState = !hardwareStates[device];
            openModal(`${device.toUpperCase()} Control`, `Authorization required to toggle ${device} to ${newState ? 'ON' : 'OFF'}.`, { type: 'hw', device, state: newState });
        };

        window.requestColorChange = (color) => {
            if (color === hardwareStates.color) return;
            openModal("Spectrum Override", `Authorization required to switch light spectrum to ${color.toUpperCase()}.`, { type: 'color', color });
        };

        window.handleAuthorizedAction = async () => {
            if (adminPassInput.value !== 'vss123') {
                modalError.classList.remove('hidden');
                return;
            }

            if (!pendingAction) return;

            try {
                if (pendingAction.type === 'purge') {
                    const keysToDelete = [];
                    Object.entries(allRawData).forEach(([key, val]) => {
                        const p = val.project || {};
                        const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                        if (currentProjectFilter === 'all' || projKey === currentProjectFilter) keysToDelete.push(key);
                    });
                    const deletePromises = keysToDelete.map(key => remove(ref(db, `logs/${key}`)));
                    await Promise.all(deletePromises);
                    addLog("Database records purged successfully.", "success");
                } 
                else if (pendingAction.type === 'hw') {
                    await set(ref(db, `control/${pendingAction.device}`), pendingAction.state);
                    addLog(`${pendingAction.device.toUpperCase()} toggle command successful.`, "success");
                }
                else if (pendingAction.type === 'color') {
                    await set(ref(db, `control/color`), pendingAction.color);
                    addLog(`Light spectrum set to ${pendingAction.color.toUpperCase()}.`, "success");
                }
            } catch (err) {
                addLog(`Action failed: ${err.message}`, "error");
            }

            closeModal();
        };

        // Real-time Listeners
        onValue(controlRef, (snapshot) => {
            const data = snapshot.val() || {};
            hardwareStates.fan = !!data.fan;
            hardwareStates.light = !!data.light;
            hardwareStates.color = data.color || 'white';

            // Fan UI Update
            fanBtn.classList.toggle('btn-active-emerald', hardwareStates.fan);
            fanStatusText.innerText = hardwareStates.fan ? "ACTIVE" : "STANDBY";
            fanStatusText.classList.toggle('opacity-100', hardwareStates.fan);
            fanStatusText.classList.toggle('opacity-50', !hardwareStates.fan);

            // Light UI Update
            lightBtn.classList.toggle('btn-active-amber', hardwareStates.light);
            lightStatusText.innerText = hardwareStates.light ? "ACTIVE" : "STANDBY";
            lightStatusText.classList.toggle('opacity-100', hardwareStates.light);
            lightStatusText.classList.toggle('opacity-50', !hardwareStates.light);

            // Show/Hide Spectrum Panel
            if (hardwareStates.light) {
                spectrumPanel.classList.remove('hidden');
            } else {
                spectrumPanel.classList.add('hidden');
            }

            // Sync text button active states
            document.querySelectorAll('.color-select-btn').forEach(btn => {
                btn.classList.toggle('color-btn-active', btn.dataset.color === hardwareStates.color);
            });
        });

        // UI Update Logic
        function updateUI() {
            const now = Date.now();
            let filtered = allDataPoints;
            if (currentProjectFilter !== 'all') filtered = filtered.filter(d => d.projectKey === currentProjectFilter);
            if (currentTimeFilter === '10m') filtered = filtered.filter(d => d.timestamp >= (now - 600000));
            else if (currentTimeFilter === '1d') filtered = filtered.filter(d => d.timestamp >= (now - 86400000));

            const labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

            const charts = [
                { chart: tempChart, data: filtered.map(d => d.temperature), stat: 'temp-stat', avgEl: 'temp-avg', unit: '°C' },
                { chart: humidChart, data: filtered.map(d => d.humidity), stat: 'humid-stat', avgEl: 'humid-avg', unit: '%' },
                { chart: lightChart, data: filtered.map(d => d.light), stat: 'light-stat', avgEl: 'light-avg', unit: '%' }
            ];

            charts.forEach(c => {
                c.chart.data.labels = labels;
                c.chart.data.datasets[0].data = c.data;
                c.chart.update('none');
                
                const lastVal = c.data[c.data.length - 1];
                document.getElementById(c.stat).innerText = (lastVal !== null && !isNaN(lastVal)) ? `${lastVal.toFixed(1)}${c.unit}` : '--';

                const validPoints = c.data.filter(v => v !== null && !isNaN(v));
                if (validPoints.length > 0) {
                    const avg = validPoints.reduce((a, b) => a + b, 0) / validPoints.length;
                    document.getElementById(c.avgEl).innerText = `Avg: ${avg.toFixed(1)}${c.unit}`;
                } else { document.getElementById(c.avgEl).innerText = `Avg: --`; }
            });

            if (allDataPoints.length > 0) {
                const latest = allDataPoints[allDataPoints.length - 1];
                const isOffline = (now - latest.timestamp) > 600000;
                
                if (isOffline) {
                    statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-rose-500"></span> System Offline`;
                    statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-rose-500/10 text-rose-400 border border-rose-500/20";
                    liveIndicator.classList.add('hidden');
                } else {
                    statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> System Online`;
                    statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
                    liveIndicator.classList.remove('hidden');
                }

                const failing = [];
                if (latest.temperature === null || isNaN(latest.temperature)) failing.push("Temp");
                if (latest.humidity === null || isNaN(latest.humidity)) failing.push("Humid");
                if (latest.light === null || isNaN(latest.light)) failing.push("Light");

                if (failing.length > 0) {
                    sensorBanner.style.display = 'block';
                    faultDetails.innerText = `${failing.join(", ")} sensors returning NULL.`;
                } else { sensorBanner.style.display = 'none'; }

                updateStatCard('Current Temperature', (latest.temperature !== null && !isNaN(latest.temperature)) ? latest.temperature.toFixed(1) : '--', '°C', 'blue');
                updateStatCard('Current Humidity', (latest.humidity !== null && !isNaN(latest.humidity)) ? latest.humidity.toFixed(1) : '--', '%', 'emerald');
                updateStatCard('Current Light', (latest.light !== null && !isNaN(latest.light)) ? latest.light.toFixed(1) : '--', '%', 'amber');
            }
            dataCountDisplay.innerText = `${filtered.length} Points Filtered`;
        }

        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            let color = 'text-slate-400', prefix = '●';
            if (type === 'success') { color = 'text-emerald-400'; prefix = '✓'; }
            if (type === 'error') { color = 'text-rose-400'; prefix = '×'; }
            entry.className = `${color} flex gap-3 transition-all duration-300`;
            entry.innerHTML = `<span class="text-slate-700 shrink-0">[${time}]</span> <span class="shrink-0 font-bold">${prefix}</span> <span>${msg}</span>`;
            logContainer.prepend(entry);
            if(logContainer.children.length > 30) logContainer.lastChild.remove();
        }

        function updateStatCard(key, value, unit = '', color = 'blue') {
            const id = `val-${key.replace(/\s+/g, '-').toLowerCase()}`;
            if (!cardElements[id]) {
                const card = document.createElement('div');
                const borderColor = color === 'emerald' ? 'hover:border-emerald-500/30' : color === 'amber' ? 'hover:border-amber-500/30' : 'hover:border-blue-500/30';
                card.className = `glass-card p-6 rounded-3xl group border-l-2 border-transparent ${borderColor} transition-all duration-500`;
                card.innerHTML = `<p class="text-slate-500 text-[10px] font-bold mb-2 tracking-[0.2em] uppercase">${key}</p><div class="flex items-baseline gap-1"><h2 id="${id}" class="text-4xl font-black text-white stat-glow">--</h2><span class="text-slate-400 text-sm font-bold uppercase">${unit}</span></div>`;
                statsGrid.appendChild(card);
                cardElements[id] = document.getElementById(id);
                if (statsGrid.children[0]?.innerText.includes("Hardware")) statsGrid.children[0].remove();
            }
            cardElements[id].innerText = value;
        }

        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) { allRawData = {}; allDataPoints = []; updateUI(); return; }
            allRawData = data; uniqueProjects.clear();
            allDataPoints = Object.entries(data).map(([key, val]) => {
                const p = val.project || {};
                const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                uniqueProjects.add(projKey);
                const t = parseFloat(val.temperature), h = parseFloat(val.humidity), l = parseFloat(val.light_level ?? val.light);
                return {
                    timestamp: val.timestamp || 0,
                    temperature: isNaN(t) ? null : t, humidity: isNaN(h) ? null : h, light: isNaN(l) ? null : l,
                    projectKey: projKey
                };
            }).sort((a, b) => a.timestamp - b.timestamp);
            
            const allBtn = projectContainer.querySelector('[data-project="all"]');
            projectContainer.innerHTML = ''; projectContainer.appendChild(allBtn);
            Array.from(uniqueProjects).sort().forEach(projKey => {
                const btn = document.createElement('button');
                btn.onclick = () => setProjectFilter(projKey);
                btn.dataset.project = projKey;
                btn.className = `project-btn w-full text-left px-4 py-3 rounded-xl text-[10px] font-bold border border-slate-700/50 hover:bg-white/5 transition-all mb-2 leading-relaxed`;
                const p = projKey.split(' | ');
                btn.innerHTML = `<div class="flex justify-between items-center opacity-60 mb-1"><span>BATCH ${p[0]}</span><span>${p[1]}</span></div><div class="text-xs">${p[2]}</div>`;
                if(currentProjectFilter === projKey) btn.classList.add('project-btn-active', 'bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
                projectContainer.appendChild(btn);
            });
            updateUI();
        });

        setInterval(updateUI, 60000);
    </script>
</body>
</html>
