<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgreen Monitor | IoT Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
            background-image: 
                radial-gradient(at 0% 0%, rgba(59, 130, 246, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 0%, rgba(16, 185, 129, 0.15) 0px, transparent 50%),
                radial-gradient(at 100% 100%, rgba(245, 158, 11, 0.1) 0px, transparent 50%),
                radial-gradient(at 0% 100%, rgba(244, 63, 94, 0.1) 0px, transparent 50%);
            background-attachment: fixed;
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.45);
            backdrop-filter: blur(25px) saturate(180%);
            -webkit-backdrop-filter: blur(25px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.07);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
        }

        .filter-btn-active {
            background: rgba(59, 130, 246, 0.1);
            border-color: rgba(59, 130, 246, 0.3);
            color: #2563eb;
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.05);
        }

        .stat-glow {
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.05));
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.8; transform: scale(0.98); }
        }
        .animate-pulse-soft {
            animation: pulse-soft 3s ease-in-out infinite;
        }

        #password-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(12px);
            align-items: center;
            justify-content: center;
        }

        .sensor-banner {
            display: none;
            animation: slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1);
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* Control Button States */
        .btn-active-emerald {
            background: rgba(16, 185, 129, 0.15) !important;
            border-color: rgba(16, 185, 129, 0.4) !important;
            color: #059669 !important;
        }
        .btn-active-amber {
            background: rgba(245, 158, 11, 0.15) !important;
            border-color: rgba(245, 158, 11, 0.4) !important;
            color: #d97706 !important;
        }
        .btn-active-blue {
            background: rgba(59, 130, 246, 0.15) !important;
            border-color: rgba(59, 130, 246, 0.4) !important;
            color: #2563eb !important;
        }

        .control-btn-active {
            background: rgba(59, 130, 246, 0.1) !important;
            border-color: rgba(59, 130, 246, 0.4) !important;
            color: #2563eb !important;
            font-weight: 700;
        }
    </style>
</head>
<body class="text-slate-900 min-h-screen selection:bg-blue-200">

    <!-- Sensor Failure Banner -->
    <div id="sensor-fault-banner" class="sensor-banner sticky top-0 z-[60] bg-rose-500 text-white px-6 py-3 shadow-lg">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 animate-bounce" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div>
                    <span class="font-bold uppercase tracking-widest text-xs">Sensor Fault</span>
                    <span id="fault-details" class="ml-2 text-sm font-medium opacity-90">Hardware modules returning NULL.</span>
                </div>
            </div>
            <button onclick="document.getElementById('sensor-fault-banner').style.display='none'" class="hover:bg-white/20 p-1 rounded-full transition-colors">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>

    <!-- Unified Authorization Modal -->
    <div id="password-modal">
        <div class="glass-card p-8 rounded-[2.5rem] w-full max-w-md border-white shadow-2xl">
            <h3 class="text-2xl font-extrabold text-slate-900 mb-2" id="modal-title">Authorize</h3>
            <p id="modal-desc" class="text-slate-500 text-sm mb-6 leading-relaxed">Password required to modify hardware state.</p>
            
            <input type="password" id="admin-pass" placeholder="••••••••" 
                class="w-full bg-white/50 border border-slate-200 rounded-2xl px-5 py-4 text-slate-900 focus:outline-none focus:ring-4 focus:ring-blue-500/10 focus:border-blue-500 transition-all mb-4 font-mono text-lg tracking-widest">
            
            <div id="modal-error" class="text-rose-600 text-xs font-bold uppercase tracking-widest mb-4 hidden px-2">Incorrect Password</div>

            <div class="grid grid-cols-2 gap-4">
                <button onclick="closeModal()" class="py-4 rounded-2xl text-sm font-bold bg-slate-100 hover:bg-slate-200 transition-all text-slate-600">Cancel</button>
                <button onclick="handleAuthorizedAction()" class="py-4 rounded-2xl text-sm font-bold bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-600/20 transition-all text-white" id="modal-confirm-btn">Confirm</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-6 md:p-10">
        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-12 gap-8">
            <div class="space-y-4">
                <div class="flex items-center gap-4">
                    <div class="p-3 glass-card rounded-2xl border-white bg-blue-500/10 shadow-none">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-8 h-8 text-blue-600" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tight text-slate-900">
                        Microgreen <span class="text-blue-600">Monitor</span>
                    </h1>
                </div>
                <div class="flex flex-col gap-2">
                    <span id="current-project-label" class="text-slate-600 font-semibold text-lg">Biosphere Intelligence Center</span>
                    <div class="flex items-center gap-2">
                        <span class="w-2 h-2 rounded-full bg-slate-300"></span>
                        <span id="last-update-text" class="text-[11px] font-bold text-slate-400 uppercase tracking-[0.15em]">Last Telemetry: Syncing...</span>
                    </div>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3">
                <div id="status-badge" class="flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-[0.2em] bg-white border border-slate-200 text-slate-400 shadow-sm transition-all duration-500">
                    <span class="w-2 h-2 rounded-full bg-slate-300 animate-pulse"></span>
                    Initializing...
                </div>
                <div id="live-indicator" class="hidden flex items-center gap-2 text-[10px] font-bold text-blue-500 uppercase tracking-widest">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-blue-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-blue-500"></span>
                    </span>
                    Live Stream Active
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            
            <!-- Left Column: Controls & Stats -->
            <div class="lg:col-span-4 space-y-8">
                <!-- Hardware Overrides -->
                <div class="glass-card p-8 rounded-[2.5rem]">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.25em] mb-6">Hardware Overrides</h3>
                    <div class="grid grid-cols-2 gap-4">
                        <button id="fan-toggle" onclick="requestHardwareToggle('fan')" class="flex flex-col items-center gap-4 p-5 rounded-[1.75rem] border border-slate-200 bg-white/40 hover:bg-white/60 transition-all group">
                            <div class="w-12 h-12 rounded-2xl bg-white shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M14 5l7 7m0 0l-7 7m7-7H3"></path></svg>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">Fan</p>
                                <span id="fan-status-text" class="text-[10px] font-bold opacity-40">OFFLINE</span>
                            </div>
                        </button>
                        <button id="light-toggle" onclick="requestHardwareToggle('light')" class="flex flex-col items-center gap-4 p-5 rounded-[1.75rem] border border-slate-200 bg-white/40 hover:bg-white/60 transition-all group">
                            <div class="w-12 h-12 rounded-2xl bg-white shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364-6.364l-.707.707M6.343 17.657l-.707.707m12.728 0l-.707-.707M6.343 6.343l-.707-.707M12 8a4 4 0 100 8 4 4 0 000-8z"></path></svg>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">Light</p>
                                <span id="light-status-text" class="text-[10px] font-bold opacity-40">OFFLINE</span>
                            </div>
                        </button>
                        <button id="mist-toggle" onclick="requestHardwareToggle('mist')" class="flex flex-col items-center gap-4 p-5 rounded-[1.75rem] border border-slate-200 bg-white/40 hover:bg-white/60 transition-all group col-span-2">
                            <div class="w-12 h-12 rounded-2xl bg-white shadow-sm flex items-center justify-center group-hover:scale-110 transition-transform">
                                <svg class="w-6 h-6 text-slate-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-1.932 0l-2.387.477a2 2 0 00-1.022.547l-3.84 3.84a12.01 12.01 0 0019.38 0l-3.84-3.84z"></path></svg>
                            </div>
                            <div class="text-center">
                                <p class="text-[10px] font-black uppercase tracking-widest text-slate-500">Mist Module</p>
                                <span id="mist-status-text" class="text-[10px] font-bold opacity-40">OFFLINE</span>
                            </div>
                        </button>
                    </div>

                    <!-- Spectrum Panel -->
                    <div id="spectrum-panel" class="hidden space-y-4 pt-8 mt-8 border-t border-slate-200/50 animate-slideDown">
                        <h4 class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em]">Spectrum Selection</h4>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="requestColorChange('blurple')" data-color="blurple" class="color-select-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">Blurple</button>
                            <button onclick="requestColorChange('white')" data-color="white" class="color-select-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">White</button>
                            <button onclick="requestColorChange('red')" data-color="red" class="color-select-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">Red</button>
                            <button onclick="requestColorChange('blue')" data-color="blue" class="color-select-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">Blue</button>
                        </div>
                    </div>
                </div>

                <!-- Project Selector -->
                <div class="glass-card p-8 rounded-[2.5rem]">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.25em]">Active Batches</h3>
                        <button onclick="requestClearData()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-xl bg-rose-50 border border-rose-100 text-rose-600 hover:bg-rose-100 active:scale-95 transition-all text-[10px] font-black uppercase tracking-widest">
                            Purge
                        </button>
                    </div>
                    <div class="space-y-3 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar" id="project-filter-container">
                        <button onclick="setProjectFilter('all')" data-project="all" class="project-btn project-btn-active w-full text-left px-5 py-4 rounded-2xl text-[11px] font-bold border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">
                            All Active Experiments
                        </button>
                    </div>
                </div>

                <!-- Timeline Selector -->
                <div class="glass-card p-8 rounded-[2.5rem]">
                    <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.25em] mb-6">View range</h3>
                    <div class="grid grid-cols-3 gap-3" id="time-filter-container">
                        <button onclick="setTimeFilter('10m')" data-time="10m" class="time-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">10m</button>
                        <button onclick="setTimeFilter('1d')" data-time="1d" class="time-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">24h</button>
                        <button onclick="setTimeFilter('all')" data-time="all" class="time-btn-active time-btn py-3 rounded-2xl text-[11px] font-bold uppercase border border-slate-200 bg-white/50 hover:bg-white/80 transition-all">All</button>
                    </div>
                </div>

                <!-- Stats Stack -->
                <div id="stats-grid" class="grid grid-cols-1 gap-6">
                    <div class="glass-card p-8 rounded-[2.5rem] animate-pulse-soft flex flex-col items-center justify-center min-h-[140px]">
                        <p class="text-slate-400 text-sm italic">Synchronizing sensors...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visualization Grid -->
            <div class="lg:col-span-8 space-y-8">
                <!-- Temperature Chart -->
                <div class="glass-card p-8 rounded-[3rem] border-l-[6px] border-blue-500/50">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 id="temp-header-label" class="text-xl font-black text-slate-900 tracking-tight transition-all">Temp: --</h3>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Thermal Stability</p>
                        </div>
                        <div id="temp-avg" class="px-3 py-1.5 rounded-full bg-blue-50 border border-blue-100 text-[10px] font-black text-blue-600 uppercase tracking-tighter shadow-sm">Avg: --</div>
                    </div>
                    <div class="h-[240px] w-full">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- Humidity Chart -->
                <div class="glass-card p-8 rounded-[3rem] border-l-[6px] border-emerald-500/50">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 id="humid-header-label" class="text-xl font-black text-slate-900 tracking-tight transition-all">Humidity: --</h3>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Vapor Pressure</p>
                        </div>
                        <div id="humid-avg" class="px-3 py-1.5 rounded-full bg-emerald-500/10 border border-emerald-500/20 text-[10px] font-black text-emerald-700 uppercase tracking-tighter shadow-sm">Avg: --</div>
                    </div>
                    <div class="h-[240px] w-full">
                        <canvas id="humidChart"></canvas>
                    </div>
                </div>

                <!-- Light Chart -->
                <div class="glass-card p-8 rounded-[3rem] border-l-[6px] border-amber-500/50">
                    <div class="flex justify-between items-start mb-6">
                        <div>
                            <h3 id="light-header-label" class="text-xl font-black text-slate-900 tracking-tight transition-all">Light: --</h3>
                            <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest mt-1">Intensity Index</p>
                        </div>
                        <div id="light-avg" class="px-3 py-1.5 rounded-full bg-amber-500/10 border border-amber-500/20 text-[10px] font-black text-amber-700 uppercase tracking-tighter shadow-sm">Avg: --</div>
                    </div>
                    <div class="h-[240px] w-full">
                        <canvas id="lightChart"></canvas>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="glass-card rounded-[3rem] flex flex-col h-[300px] overflow-hidden">
                    <div class="px-8 py-5 border-b border-slate-100 flex justify-between items-center bg-white/40">
                        <h3 class="text-xs font-black text-slate-400 uppercase tracking-[0.25em]">System Logic</h3>
                        <span id="data-point-count" class="text-[10px] font-bold text-blue-500 bg-blue-50 px-3 py-1 rounded-full">0 Points</span>
                    </div>
                    <div id="log-container" class="flex-grow p-8 space-y-4 font-mono text-[11px] overflow-y-auto custom-scrollbar">
                        <div class="text-slate-400 italic">Listening for heartbeats...</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-16 mb-8 text-center">
            <p class="text-slate-300 text-[10px] font-black uppercase tracking-[0.6em]">Biosphere Controller v4.0.0 &copy; 2024</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove, set } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnuEebPEA9rY5ILG8F3zRVNzQj9xfxm-Y",
            authDomain: "microgreens-ae75c.firebaseapp.com",
            databaseURL: "https://microgreens-ae75c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "microgreens-ae75c",
            storageBucket: "microgreens-ae75c.firebasestorage.app",
            messagingSenderId: "134579315817",
            appId: "1:134579315817:web:3b5387c5ad92e254496ef8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logsRef = ref(db, 'logs'); 
        const controlRef = ref(db, 'control'); 

        // DOM caching
        const statusBadge = document.getElementById('status-badge');
        const liveIndicator = document.getElementById('live-indicator');
        const logContainer = document.getElementById('log-container');
        const statsGrid = document.getElementById('stats-grid');
        const dataCountDisplay = document.getElementById('data-point-count');
        const projectContainer = document.getElementById('project-filter-container');
        const passwordModal = document.getElementById('password-modal');
        const adminPassInput = document.getElementById('admin-pass');
        const modalError = document.getElementById('modal-error');
        const modalTitle = document.getElementById('modal-title');
        const modalDesc = document.getElementById('modal-desc');
        const sensorBanner = document.getElementById('sensor-fault-banner');
        const faultDetails = document.getElementById('fault-details');
        const lastUpdateLabel = document.getElementById('last-update-text');
        
        const fanBtn = document.getElementById('fan-toggle');
        const lightBtn = document.getElementById('light-toggle');
        const mistBtn = document.getElementById('mist-toggle');
        
        const fanStatusText = document.getElementById('fan-status-text');
        const lightStatusText = document.getElementById('light-status-text');
        const mistStatusText = document.getElementById('mist-status-text');
        
        const spectrumPanel = document.getElementById('spectrum-panel');

        let currentTimeFilter = 'all';
        let currentProjectFilter = 'all';
        let allRawData = {};
        let allDataPoints = [];
        let uniqueProjects = new Set();
        const cardElements = {};
        let pendingAction = null;
        let hardwareStates = { fan: false, light: false, mist: false, color: 'white' };

        // Chart Initialization
        function createChart(id, color, label) {
            const ctx = document.getElementById(id).getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 240);
            gradient.addColorStop(0, `${color}22`);
            gradient.addColorStop(1, `${color}00`);

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ 
                        label, data: [], borderColor: color, borderWidth: 3.5, 
                        backgroundColor: gradient, fill: true, tension: 0.45, 
                        pointRadius: 0, pointHitRadius: 15, pointHoverRadius: 6,
                        pointHoverBackgroundColor: color, pointHoverBorderColor: '#fff',
                        pointHoverBorderWidth: 3, spanGaps: true
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#0f172a',
                            bodyColor: '#0f172a',
                            bodyFont: { weight: 'bold' },
                            padding: 12,
                            borderColor: 'rgba(0,0,0,0.05)',
                            borderWidth: 1,
                            cornerRadius: 12,
                            displayColors: false
                        }
                    },
                    scales: {
                        y: { grid: { color: 'rgba(0,0,0,0.04)', drawBorder: false }, ticks: { color: '#94a3b8', font: { size: 10, weight: 'bold' } } },
                        x: { grid: { display: false }, ticks: { color: '#94a3b8', font: { size: 10, weight: 'bold' }, autoSkip: true, maxTicksLimit: 6 } }
                    }
                }
            });
        }

        const tempChart = createChart('tempChart', '#3b82f6', 'Temp (°C)');
        const humidChart = createChart('humidChart', '#10b981', 'Humidity (%)');
        const lightChart = createChart('lightChart', '#f59e0b', 'Light (%)');

        // Handlers
        window.setTimeFilter = (filter) => {
            currentTimeFilter = filter;
            document.querySelectorAll('.time-btn').forEach(btn => btn.classList.toggle('filter-btn-active', btn.dataset.time === filter));
            updateUI();
        };

        window.setProjectFilter = (filter) => {
            currentProjectFilter = filter;
            document.querySelectorAll('.project-btn').forEach(btn => {
                const isActive = btn.dataset.project === filter;
                btn.classList.toggle('filter-btn-active', isActive);
            });
            updateUI();
        };

        window.openModal = (title, desc, action) => {
            modalTitle.innerText = title;
            modalDesc.innerText = desc;
            pendingAction = action;
            passwordModal.style.display = 'flex';
            adminPassInput.value = '';
            adminPassInput.focus();
            modalError.classList.add('hidden');
        };

        window.closeModal = () => {
            passwordModal.style.display = 'none';
            pendingAction = null;
        };

        window.requestClearData = () => {
            const label = currentProjectFilter === 'all' ? 'all telemetry logs' : `Batch ${currentProjectFilter.split(' | ')[0]}`;
            openModal("Purge Cloud Data", `Admin clearance required to permanently delete ${label}.`, { type: 'purge' });
        };

        window.requestHardwareToggle = (device) => {
            const newState = !hardwareStates[device];
            openModal(`${device.toUpperCase()} Control`, `Clearance required to switch ${device} to ${newState ? 'ACTIVE' : 'STANDBY'}.`, { type: 'hw', device, state: newState });
        };

        window.requestColorChange = (color) => {
            if (color === hardwareStates.color) return;
            openModal("Spectrum Override", `Clearance required to shift output to ${color.toUpperCase()}.`, { type: 'color', color });
        };

        window.handleAuthorizedAction = async () => {
            if (adminPassInput.value !== 'vss123') {
                modalError.classList.remove('hidden');
                adminPassInput.classList.add('border-rose-500');
                return;
            }

            if (!pendingAction) return;

            try {
                if (pendingAction.type === 'purge') {
                    const keysToDelete = [];
                    Object.entries(allRawData).forEach(([key, val]) => {
                        const p = val.project || {};
                        const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                        if (currentProjectFilter === 'all' || projKey === currentProjectFilter) keysToDelete.push(key);
                    });
                    const deletePromises = keysToDelete.map(key => remove(ref(db, `logs/${key}`)));
                    await Promise.all(deletePromises);
                    addLog("Manual cache purge successful.", "success");
                } 
                else if (pendingAction.type === 'hw') {
                    await set(ref(db, `control/${pendingAction.device}`), pendingAction.state);
                    addLog(`${pendingAction.device.toUpperCase()} command acknowledged.`, "success");
                }
                else if (pendingAction.type === 'color') {
                    await set(ref(db, `control/color`), pendingAction.color);
                    addLog(`Spectral shift to ${pendingAction.color.toUpperCase()} complete.`, "success");
                }
            } catch (err) {
                addLog(`Command rejection: ${err.message}`, "error");
            }

            closeModal();
        };

        function updateUI() {
            const now = Date.now();
            let filtered = allDataPoints;
            if (currentProjectFilter !== 'all') filtered = filtered.filter(d => d.projectKey === currentProjectFilter);
            if (currentTimeFilter === '10m') filtered = filtered.filter(d => d.timestamp >= (now - 600000));
            else if (currentTimeFilter === '1d') filtered = filtered.filter(d => d.timestamp >= (now - 86400000));

            const labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

            const charts = [
                { chart: tempChart, data: filtered.map(d => d.temperature), headerId: 'temp-header-label', labelPrefix: 'Temp: ', avgEl: 'temp-avg', unit: '°C' },
                { chart: humidChart, data: filtered.map(d => d.humidity), headerId: 'humid-header-label', labelPrefix: 'Humidity: ', avgEl: 'humid-avg', unit: '%' },
                { chart: lightChart, data: filtered.map(d => d.light), headerId: 'light-header-label', labelPrefix: 'Light Index: ', avgEl: 'light-avg', unit: '%' }
            ];

            charts.forEach(c => {
                c.chart.data.labels = labels;
                c.chart.data.datasets[0].data = c.data;
                c.chart.update('none');
                
                const lastVal = c.data[c.data.length - 1];
                const displayVal = (lastVal !== null && !isNaN(lastVal)) ? `${lastVal.toFixed(1)}${c.unit}` : '--';
                document.getElementById(c.headerId).innerText = `${c.labelPrefix}${displayVal}`;

                const validPoints = c.data.filter(v => v !== null && !isNaN(v));
                if (validPoints.length > 0) {
                    const avg = validPoints.reduce((a, b) => a + b, 0) / validPoints.length;
                    document.getElementById(c.avgEl).innerText = `Avg: ${avg.toFixed(1)}${c.unit}`;
                } else { document.getElementById(c.avgEl).innerText = `Avg: --`; }
            });

            if (allDataPoints.length > 0) {
                const latest = allDataPoints[allDataPoints.length - 1];
                const updateTime = new Date(latest.timestamp).toLocaleTimeString([], { hour12: true, hour: '2-digit', minute: '2-digit', second: '2-digit' });
                lastUpdateLabel.innerText = `Last Heartbeat: ${updateTime}`;

                const isOffline = (now - latest.timestamp) > 600000;
                if (isOffline) {
                    statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-rose-500 shadow-[0_0_8px_rgba(244,63,94,0.5)]"></span> Offline`;
                    statusBadge.className = "flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-[0.2em] bg-rose-50 border border-rose-100 text-rose-600 shadow-sm";
                    liveIndicator.classList.add('hidden');
                } else {
                    statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500 shadow-[0_0_8px_rgba(16,185,129,0.5)]"></span> Active`;
                    statusBadge.className = "flex items-center gap-2 px-4 py-2 rounded-full text-[10px] font-black uppercase tracking-[0.2em] bg-emerald-50 border border-emerald-100 text-emerald-600 shadow-sm";
                    liveIndicator.classList.remove('hidden');
                }

                const failing = [];
                if (latest.temperature === null || isNaN(latest.temperature)) failing.push("Temp");
                if (latest.humidity === null || isNaN(latest.humidity)) failing.push("Humid");
                if (latest.light === null || isNaN(latest.light)) failing.push("Light");

                if (failing.length > 0) {
                    sensorBanner.style.display = 'block';
                    faultDetails.innerText = `${failing.join(", ")} diagnostics returning NULL.`;
                } else { sensorBanner.style.display = 'none'; }

                updateStatCard('Current Temp', (latest.temperature !== null && !isNaN(latest.temperature)) ? latest.temperature.toFixed(1) : '--', '°C', 'blue');
                updateStatCard('Current Humid', (latest.humidity !== null && !isNaN(latest.humidity)) ? latest.humidity.toFixed(1) : '--', '%', 'emerald');
                updateStatCard('Current Light', (latest.light !== null && !isNaN(latest.light)) ? `${latest.light.toFixed(1)}%` : '--', '', 'amber');
            }
            dataCountDisplay.innerText = `${filtered.length} Data Sets`;
        }

        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            let color = 'text-slate-500', icon = '○';
            if (type === 'success') { color = 'text-emerald-600 font-bold'; icon = '✓'; }
            if (type === 'error') { color = 'text-rose-600 font-bold'; icon = '×'; }
            entry.className = `${color} flex gap-4 transition-all duration-300 items-baseline`;
            entry.innerHTML = `<span class="text-slate-300 font-bold shrink-0">${time}</span> <span class="shrink-0">${icon}</span> <span>${msg}</span>`;
            logContainer.prepend(entry);
            if(logContainer.children.length > 25) logContainer.lastChild.remove();
        }

        function updateStatCard(key, value, unit = '', color = 'blue') {
            const id = `val-${key.replace(/\s+/g, '-').toLowerCase()}`;
            if (!cardElements[id]) {
                const card = document.createElement('div');
                const accent = color === 'emerald' ? 'border-emerald-500/50' : color === 'amber' ? 'border-amber-500/50' : 'border-blue-500/50';
                card.className = `glass-card p-8 rounded-[2.5rem] border-l-[6px] ${accent} transition-all duration-500`;
                card.innerHTML = `<p class="text-[10px] font-black text-slate-400 uppercase tracking-[0.25em] mb-2">${key}</p><div class="flex items-baseline gap-1"><h2 id="${id}" class="text-4xl font-black text-slate-900">--</h2><span class="text-slate-400 text-sm font-bold">${unit}</span></div>`;
                statsGrid.appendChild(card);
                cardElements[id] = document.getElementById(id);
                if (statsGrid.children[0]?.innerText.includes("Synchronizing")) statsGrid.children[0].remove();
            }
            cardElements[id].innerText = value;
        }

        // Listeners
        onValue(controlRef, (snapshot) => {
            const data = snapshot.val() || {};
            hardwareStates.fan = !!data.fan;
            hardwareStates.light = !!data.light;
            hardwareStates.mist = !!data.mist;
            hardwareStates.color = data.color || 'white';

            fanBtn.classList.toggle('btn-active-emerald', hardwareStates.fan);
            fanStatusText.innerText = hardwareStates.fan ? "ACTIVE" : "STANDBY";
            fanStatusText.className = `text-[10px] font-bold ${hardwareStates.fan ? 'text-emerald-600' : 'opacity-40'}`;

            lightBtn.classList.toggle('btn-active-amber', hardwareStates.light);
            lightStatusText.innerText = hardwareStates.light ? "ACTIVE" : "STANDBY";
            lightStatusText.className = `text-[10px] font-bold ${hardwareStates.light ? 'text-amber-600' : 'opacity-40'}`;
            
            mistBtn.classList.toggle('btn-active-blue', hardwareStates.mist);
            mistStatusText.innerText = hardwareStates.mist ? "ACTIVE" : "STANDBY";
            mistStatusText.className = `text-[10px] font-bold ${hardwareStates.mist ? 'text-blue-600' : 'opacity-40'}`;

            spectrumPanel.classList.toggle('hidden', !hardwareStates.light);
            document.querySelectorAll('.color-select-btn').forEach(btn => btn.classList.toggle('control-btn-active', btn.dataset.color === hardwareStates.color));
        });

        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) { allRawData = {}; allDataPoints = []; updateUI(); return; }
            allRawData = data; uniqueProjects.clear();
            allDataPoints = Object.entries(data).map(([key, val]) => {
                const p = val.project || {};
                const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                uniqueProjects.add(projKey);
                const t = parseFloat(val.temperature), h = parseFloat(val.humidity), l = parseFloat(val.light_level ?? val.light);
                return {
                    timestamp: val.timestamp || 0,
                    temperature: isNaN(t) ? null : t, humidity: isNaN(h) ? null : h, light: isNaN(l) ? null : l,
                    projectKey: projKey
                };
            }).sort((a, b) => a.timestamp - b.timestamp);
            
            const allBtn = projectContainer.querySelector('[data-project="all"]');
            projectContainer.innerHTML = ''; projectContainer.appendChild(allBtn);
            Array.from(uniqueProjects).sort().forEach(projKey => {
                const btn = document.createElement('button');
                btn.onclick = () => setProjectFilter(projKey);
                btn.dataset.project = projKey;
                btn.className = `project-btn w-full text-left px-5 py-4 rounded-2xl text-[11px] font-bold border border-slate-200 bg-white/50 hover:bg-white/80 transition-all leading-relaxed`;
                const p = projKey.split(' | ');
                btn.innerHTML = `<div class="flex justify-between items-center opacity-40 mb-1"><span>BATCH ${p[0]}</span><span>${p[1]}</span></div><div class="text-xs text-slate-900">${p[2]}</div>`;
                if(currentProjectFilter === projKey) btn.classList.add('filter-btn-active');
                projectContainer.appendChild(btn);
            });
            updateUI();
        });

        setInterval(updateUI, 30000);
    </script>
</body>
</html>
