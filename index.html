<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgreen Monitor | IoT Intelligence</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono:wght@400;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background: radial-gradient(circle at top right, #0f172a, #020617);
        }

        .glass-card {
            background: rgba(30, 41, 59, 0.4);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.37);
        }

        .custom-scrollbar::-webkit-scrollbar {
            width: 5px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: rgba(71, 85, 105, 0.5);
            border-radius: 10px;
        }

        .filter-btn-active {
            background: rgba(59, 130, 246, 0.15);
            border-color: rgba(59, 130, 246, 0.4);
            color: #60a5fa;
            box-shadow: 0 0 15px rgba(59, 130, 246, 0.1);
        }

        .stat-glow {
            filter: drop-shadow(0 0 8px rgba(59, 130, 246, 0.3));
        }
        
        @keyframes pulse-soft {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .animate-pulse-soft {
            animation: pulse-soft 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        /* Modal Backdrop */
        #password-modal {
            display: none;
            position: fixed;
            inset: 0;
            z-index: 100;
            background: rgba(2, 6, 23, 0.85);
            backdrop-filter: blur(8px);
            align-items: center;
            justify-content: center;
        }

        .sensor-banner {
            display: none;
            animation: slideDown 0.4s ease-out;
        }

        @keyframes slideDown {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="text-slate-100 min-h-screen selection:bg-blue-500/30">

    <!-- Sensor Failure Banner -->
    <div id="sensor-fault-banner" class="sensor-banner sticky top-0 z-[60] bg-rose-600 text-white px-6 py-3 shadow-2xl">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center gap-3">
                <svg class="w-6 h-6 animate-pulse" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
                <div>
                    <span class="font-bold uppercase tracking-widest text-xs">Sensor Fault Detected:</span>
                    <span id="fault-details" class="ml-2 text-sm font-medium opacity-90">One or more hardware modules are returning NULL data.</span>
                </div>
            </div>
            <button onclick="document.getElementById('sensor-fault-banner').style.display='none'" class="text-white/60 hover:text-white">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z" clip-rule="evenodd"></path></svg>
            </button>
        </div>
    </div>

    <!-- Password Modal -->
    <div id="password-modal">
        <div class="glass-card p-8 rounded-[2rem] w-full max-w-md border border-white/10 shadow-2xl">
            <h3 class="text-xl font-bold text-white mb-2">Authorize Deletion</h3>
            <p id="modal-desc" class="text-slate-400 text-sm mb-6 leading-relaxed">Please enter the administrative password to clear the selected batch data from the cloud.</p>
            
            <input type="password" id="admin-pass" placeholder="••••••••" 
                class="w-full bg-slate-950/50 border border-slate-700 rounded-xl px-4 py-3 text-white focus:outline-none focus:border-blue-500 transition-all mb-4 font-mono">
            
            <div id="modal-error" class="text-rose-400 text-[10px] font-bold uppercase tracking-widest mb-4 hidden">Invalid Password</div>

            <div class="grid grid-cols-2 gap-3">
                <button onclick="closeModal()" class="py-3 rounded-xl text-xs font-bold bg-slate-800 hover:bg-slate-700 transition-all text-slate-300">Cancel</button>
                <button onclick="confirmClearData()" class="py-3 rounded-xl text-xs font-bold bg-rose-600 hover:bg-rose-500 transition-all text-white">Clear Data</button>
            </div>
        </div>
    </div>

    <div class="max-w-7xl mx-auto p-4 md:p-10">
        <!-- Header -->
        <header class="flex flex-col lg:flex-row justify-between items-start lg:items-end mb-12 gap-6">
            <div class="space-y-2">
                <div class="flex items-center gap-3">
                    <div class="p-2 bg-emerald-500/10 rounded-lg border border-emerald-500/20">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6 text-emerald-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" />
                        </svg>
                    </div>
                    <h1 class="text-4xl md:text-5xl font-black tracking-tighter text-white">
                        MICROGREEN <span class="text-emerald-400">MONITOR</span>
                    </h1>
                </div>
                <div class="flex flex-wrap items-center gap-x-4 gap-y-1">
                    <span id="current-project-label" class="text-slate-400 font-medium text-lg italic">Intelligent Biosphere Sync</span>
                </div>
            </div>

            <div class="flex flex-col items-end gap-3 bg-slate-900/40 p-4 rounded-2xl border border-slate-800/50">
                <div id="status-badge" class="flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-slate-800 text-slate-500 border border-slate-700">
                    <span class="w-2 h-2 rounded-full bg-slate-600 animate-pulse"></span>
                    Handshaking...
                </div>
                <div id="live-indicator" class="hidden flex items-center gap-2 text-[10px] font-bold text-emerald-400 uppercase tracking-widest">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Real-time Active
                </div>
            </div>
        </header>

        <!-- Main Dashboard -->
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
            
            <!-- Left Column: Controls & Stats -->
            <div class="lg:col-span-4 space-y-6">
                <!-- Project Selector -->
                <div class="glass-card p-6 rounded-3xl">
                    <div class="flex justify-between items-center mb-6">
                        <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em]">Active Batches</h3>
                        <button onclick="openClearModal()" class="flex items-center gap-1.5 px-3 py-1.5 rounded-lg bg-rose-500/10 border border-rose-500/20 text-rose-500 hover:bg-rose-500/20 hover:border-rose-500/40 active:scale-95 transition-all text-[10px] font-bold uppercase tracking-widest">
                            <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                            Clear
                        </button>
                    </div>
                    <div class="space-y-2 max-h-[250px] overflow-y-auto pr-2 custom-scrollbar" id="project-filter-container">
                        <button onclick="setProjectFilter('all')" data-project="all" class="project-btn project-btn-active w-full text-left px-4 py-3 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">
                            All Active Batches
                        </button>
                    </div>
                </div>

                <!-- Timeline Selector -->
                <div class="glass-card p-6 rounded-3xl">
                    <h3 class="text-xs font-bold text-slate-500 uppercase tracking-[0.2em] mb-4">Time Range</h3>
                    <div class="grid grid-cols-3 gap-2" id="time-filter-container">
                        <button onclick="setTimeFilter('10m')" data-time="10m" class="time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">10m</button>
                        <button onclick="setTimeFilter('1d')" data-time="1d" class="time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">24h</button>
                        <button onclick="setTimeFilter('all')" data-time="all" class="time-btn-active time-btn py-2.5 rounded-xl text-xs font-semibold border border-slate-700/50 hover:bg-white/5 transition-all">All</button>
                    </div>
                </div>

                <!-- Stats Stack -->
                <div id="stats-grid" class="grid grid-cols-1 gap-4">
                    <div class="glass-card p-6 rounded-3xl animate-pulse-soft flex flex-col items-center justify-center min-h-[140px]">
                        <p class="text-slate-500 text-sm italic">Synchronizing hardware telemetry...</p>
                    </div>
                </div>
            </div>

            <!-- Right Column: Visualization Grid -->
            <div class="lg:col-span-8 space-y-6">
                
                <!-- Temperature Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-blue-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Temperature History (°C)</h3>
                        <div class="text-right">
                            <div id="temp-stat" class="text-sm font-black text-blue-400">--</div>
                            <div id="temp-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- Humidity Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-emerald-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Humidity Levels (%)</h3>
                        <div class="text-right">
                            <div id="humid-stat" class="text-sm font-black text-emerald-400">--</div>
                            <div id="humid-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="humidChart"></canvas>
                    </div>
                </div>

                <!-- Light Chart -->
                <div class="glass-card p-6 rounded-[2rem] border-l-4 border-amber-500/30">
                    <div class="flex justify-between items-center mb-4">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">Light Intensity (%)</h3>
                        <div class="text-right">
                            <div id="light-stat" class="text-sm font-black text-amber-400">--</div>
                            <div id="light-avg" class="text-[10px] font-mono text-slate-500 uppercase tracking-tighter">Avg: --</div>
                        </div>
                    </div>
                    <div class="h-[200px] w-full">
                        <canvas id="lightChart"></canvas>
                    </div>
                </div>

                <!-- Event Log -->
                <div class="glass-card rounded-[2rem] flex flex-col h-[250px] overflow-hidden">
                    <div class="px-6 py-4 border-b border-slate-800/50 flex justify-between items-center bg-white/2">
                        <h3 class="text-sm font-bold text-white uppercase tracking-widest">System Log</h3>
                        <span id="data-point-count" class="text-[10px] font-mono text-slate-500">0 Points Syncing</span>
                    </div>
                    <div id="log-container" class="flex-grow p-6 space-y-3 font-mono text-[11px] overflow-y-auto custom-scrollbar bg-slate-950/20">
                        <div class="text-slate-600 animate-pulse">Initializing cloud handshake...</div>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-12 text-center">
            <p class="text-slate-600 text-[10px] uppercase tracking-[0.4em]">Integrated Intelligence System &copy; 2024</p>
        </footer>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnuEebPEA9rY5ILG8F3zRVNzQj9xfxm-Y",
            authDomain: "microgreens-ae75c.firebaseapp.com",
            databaseURL: "https://microgreens-ae75c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "microgreens-ae75c",
            storageBucket: "microgreens-ae75c.firebasestorage.app",
            messagingSenderId: "134579315817",
            appId: "1:134579315817:web:3b5387c5ad92e254496ef8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        const logsRef = ref(db, 'logs'); 

        let currentTimeFilter = 'all';
        let currentProjectFilter = 'all';
        let allRawData = {};
        let allDataPoints = [];
        let uniqueProjects = new Set();
        const cardElements = {};

        // DOM Elements
        const statusBadge = document.getElementById('status-badge');
        const liveIndicator = document.getElementById('live-indicator');
        const logContainer = document.getElementById('log-container');
        const statsGrid = document.getElementById('stats-grid');
        const dataCountDisplay = document.getElementById('data-point-count');
        const projectContainer = document.getElementById('project-filter-container');
        const passwordModal = document.getElementById('password-modal');
        const adminPassInput = document.getElementById('admin-pass');
        const modalError = document.getElementById('modal-error');
        const modalDesc = document.getElementById('modal-desc');
        const sensorBanner = document.getElementById('sensor-fault-banner');
        const faultDetails = document.getElementById('fault-details');

        // Chart Init Helper
        function createChart(id, color, label) {
            const ctx = document.getElementById(id).getContext('2d');
            const gradient = ctx.createLinearGradient(0, 0, 0, 200);
            gradient.addColorStop(0, `${color}44`);
            gradient.addColorStop(1, `${color}00`);

            return new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{ 
                        label, 
                        data: [], 
                        borderColor: color, 
                        borderWidth: 2.5, 
                        backgroundColor: gradient, 
                        fill: true, 
                        tension: 0.4, 
                        pointRadius: 0,
                        pointHoverRadius: 5,
                        spanGaps: true // CONNECT GAPS: Ensures the line doesn't break for records missing fields
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { intersect: false, mode: 'index' },
                    plugins: { 
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(15, 23, 42, 0.9)',
                            padding: 10,
                            cornerRadius: 8,
                            titleFont: { family: 'JetBrains Mono' }
                        }
                    },
                    scales: {
                        y: { 
                            grid: { color: 'rgba(255,255,255,0.03)', drawBorder: false }, 
                            ticks: { color: '#64748b', font: { size: 10 } }
                        },
                        x: { 
                            grid: { display: false }, 
                            ticks: { color: '#475569', font: { size: 9 }, autoSkip: true, maxTicksLimit: 6 } 
                        }
                    }
                }
            });
        }

        const tempChart = createChart('tempChart', '#3b82f6', 'Temp (°C)');
        const humidChart = createChart('humidChart', '#10b981', 'Humidity (%)');
        const lightChart = createChart('lightChart', '#f59e0b', 'Light (%)');

        window.setTimeFilter = (filter) => {
            currentTimeFilter = filter;
            document.querySelectorAll('.time-btn').forEach(btn => {
                btn.classList.toggle('time-btn-active', btn.dataset.time === filter);
            });
            updateUI();
        };

        window.setProjectFilter = (filter) => {
            currentProjectFilter = filter;
            document.querySelectorAll('.project-btn').forEach(btn => {
                const isActive = btn.dataset.project === filter;
                if(isActive) btn.classList.add('project-btn-active', 'bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
                else btn.classList.remove('project-btn-active', 'bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
            });
            updateUI();
        };

        window.openClearModal = () => {
            const batchName = currentProjectFilter === 'all' ? 'ALL active logs' : `Batch ${currentProjectFilter.split(' | ')[0]}`;
            modalDesc.innerText = `You are about to permanently delete all records for [${batchName}]. This action cannot be undone.`;
            passwordModal.style.display = 'flex';
            adminPassInput.value = '';
            adminPassInput.focus();
            modalError.classList.add('hidden');
        };

        window.closeModal = () => passwordModal.style.display = 'none';

        window.confirmClearData = async () => {
            if (adminPassInput.value === 'vss123') {
                const keysToDelete = [];
                Object.entries(allRawData).forEach(([key, val]) => {
                    const p = val.project || {};
                    const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                    if (currentProjectFilter === 'all' || projKey === currentProjectFilter) keysToDelete.push(key);
                });
                try {
                    const deletePromises = keysToDelete.map(key => remove(ref(db, `logs/${key}`)));
                    await Promise.all(deletePromises);
                    closeModal();
                    addLog("Batch data purged successfully.", "success");
                } catch (err) { addLog(`Purge failed: ${err.message}`, "error"); }
            } else { modalError.classList.remove('hidden'); }
        };

        function addLog(msg, type = 'info') {
            const time = new Date().toLocaleTimeString([], { hour12: false, hour: '2-digit', minute: '2-digit', second: '2-digit' });
            const entry = document.createElement('div');
            let color = 'text-slate-400', prefix = '●';
            if (type === 'success') { color = 'text-emerald-400'; prefix = '✓'; }
            if (type === 'error') { color = 'text-rose-400'; prefix = '×'; }
            entry.className = `${color} flex gap-3 transition-all duration-300`;
            entry.innerHTML = `<span class="text-slate-700 shrink-0">[${time}]</span> <span class="shrink-0 font-bold">${prefix}</span> <span>${msg}</span>`;
            logContainer.prepend(entry);
            if(logContainer.children.length > 30) logContainer.lastChild.remove();
        }

        function updateStatCard(key, value, unit = '', color = 'blue') {
            const id = `val-${key.replace(/\s+/g, '-').toLowerCase()}`;
            if (!cardElements[id]) {
                const card = document.createElement('div');
                const borderColor = color === 'emerald' ? 'hover:border-emerald-500/30' : color === 'amber' ? 'hover:border-amber-500/30' : 'hover:border-blue-500/30';
                card.className = `glass-card p-6 rounded-3xl group border-l-2 border-transparent ${borderColor} transition-all duration-500`;
                card.innerHTML = `<p class="text-slate-500 text-[10px] font-bold mb-2 tracking-[0.2em] uppercase">${key}</p><div class="flex items-baseline gap-1"><h2 id="${id}" class="text-4xl font-black text-white stat-glow">--</h2><span class="text-slate-400 text-sm font-bold uppercase">${unit}</span></div>`;
                statsGrid.appendChild(card);
                cardElements[id] = document.getElementById(id);
                if (statsGrid.children[0]?.innerText.includes("Synchronizing")) statsGrid.children[0].remove();
            }
            cardElements[id].innerText = value;
        }

        function refreshProjectFilterUI() {
            const allBtn = projectContainer.querySelector('[data-project="all"]');
            projectContainer.innerHTML = '';
            projectContainer.appendChild(allBtn);
            Array.from(uniqueProjects).sort().forEach(projKey => {
                const btn = document.createElement('button');
                btn.onclick = () => setProjectFilter(projKey);
                btn.dataset.project = projKey;
                btn.className = `project-btn w-full text-left px-4 py-3 rounded-xl text-[10px] font-bold border border-slate-700/50 hover:bg-white/5 transition-all mb-2 leading-relaxed`;
                const p = projKey.split(' | ');
                btn.innerHTML = `<div class="flex justify-between items-center opacity-60 mb-1"><span>BATCH ${p[0]}</span><span>${p[1]}</span></div><div class="text-xs">${p[2]}</div>`;
                if(currentProjectFilter === projKey) btn.classList.add('project-btn-active', 'bg-emerald-500/10', 'border-emerald-500/40', 'text-emerald-400');
                projectContainer.appendChild(btn);
            });
        }

        function formatValue(val) {
            const num = parseFloat(val);
            return isNaN(num) ? null : num;
        }

        function updateUI() {
            const now = Date.now();
            let filtered = allDataPoints;
            if (currentProjectFilter !== 'all') filtered = filtered.filter(d => d.projectKey === currentProjectFilter);
            if (currentTimeFilter === '10m') filtered = filtered.filter(d => d.timestamp >= (now - 600000));
            else if (currentTimeFilter === '1d') filtered = filtered.filter(d => d.timestamp >= (now - 86400000));

            const labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}));

            // Update Charts and Averages
            const charts = [
                { chart: tempChart, data: filtered.map(d => d.temperature), stat: 'temp-stat', avgEl: 'temp-avg', unit: '°C' },
                { chart: humidChart, data: filtered.map(d => d.humidity), stat: 'humid-stat', avgEl: 'humid-avg', unit: '%' },
                { chart: lightChart, data: filtered.map(d => d.light), stat: 'light-stat', avgEl: 'light-avg', unit: '%' }
            ];

            charts.forEach(c => {
                c.chart.data.labels = labels;
                c.chart.data.datasets[0].data = c.data;
                c.chart.update('none');
                
                // Current Value
                const lastVal = c.data[c.data.length - 1];
                const numericVal = formatValue(lastVal);
                document.getElementById(c.stat).innerText = numericVal !== null ? `${numericVal.toFixed(1)}${c.unit}` : '--';

                // Average Value (STRICT FILTERING: Ignores nulls AND NaNs)
                const validPoints = c.data.filter(v => v !== null && v !== undefined && !isNaN(v));
                if (validPoints.length > 0) {
                    const sum = validPoints.reduce((a, b) => a + b, 0);
                    const avg = sum / validPoints.length;
                    document.getElementById(c.avgEl).innerText = `Avg: ${avg.toFixed(1)}${c.unit}`;
                } else {
                    document.getElementById(c.avgEl).innerText = `Avg: --`;
                }
            });

            // Sensor Fault Check (on latest entry)
            if (allDataPoints.length > 0) {
                const latest = allDataPoints[allDataPoints.length - 1];
                const failing = [];
                if (latest.temperature === null || isNaN(latest.temperature)) failing.push("Temperature");
                if (latest.humidity === null || isNaN(latest.humidity)) failing.push("Humidity");
                if (latest.light === null || isNaN(latest.light)) failing.push("Light");

                if (failing.length > 0) {
                    sensorBanner.style.display = 'block';
                    faultDetails.innerText = `${failing.join(", ")} sensor(s) reporting null data. Check hardware connection.`;
                } else {
                    sensorBanner.style.display = 'none';
                }

                // Global Stats Card Update
                const t = formatValue(latest.temperature);
                const h = formatValue(latest.humidity);
                const l = formatValue(latest.light);
                updateStatCard('Current Temperature', t !== null ? t.toFixed(1) : '--', '°C', 'blue');
                updateStatCard('Current Humidity', h !== null ? h.toFixed(1) : '--', '%', 'emerald');
                updateStatCard('Current Light', l !== null ? l.toFixed(1) : '--', '%', 'amber');
            }
            
            dataCountDisplay.innerText = `${filtered.length} points active`;
        }

        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) { 
                allRawData = {}; allDataPoints = []; uniqueProjects.clear(); 
                refreshProjectFilterUI(); updateUI(); return; 
            }
            allRawData = data;
            uniqueProjects.clear();
            allDataPoints = Object.entries(data).map(([key, val]) => {
                const p = val.project || {};
                const projKey = `${p.batch_id || '?' } | ${p.seed_type || 'Unknown'} | ${p.substrate || 'No Substrate'}`;
                uniqueProjects.add(projKey);
                
                // MAPPER FIX: Safely parse numbers and handle the switch to 'light_level'
                const t = parseFloat(val.temperature);
                const h = parseFloat(val.humidity);
                const l = parseFloat(val.light_level ?? val.light);

                return {
                    timestamp: val.timestamp || 0,
                    temperature: isNaN(t) ? null : t,
                    humidity: isNaN(h) ? null : h,
                    light: isNaN(l) ? null : l,
                    projectKey: projKey
                };
            }).sort((a, b) => a.timestamp - b.timestamp);
            
            refreshProjectFilterUI();
            updateUI();
            statusBadge.innerHTML = `<span class="w-2 h-2 rounded-full bg-emerald-500"></span> Online`;
            statusBadge.className = "flex items-center gap-2 px-3 py-1 rounded-full text-[10px] font-bold uppercase tracking-widest bg-emerald-500/10 text-emerald-400 border border-emerald-500/20";
            liveIndicator.classList.remove('hidden');
        });
    </script>
</body>
</html>
