<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Microgreens IoT Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <style>
        .glass-card {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        .custom-scrollbar::-webkit-scrollbar {
            width: 4px;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #475569;
            border-radius: 10px;
        }
        .filter-btn-active {
            background: rgba(59, 130, 246, 0.2);
            border-color: rgba(59, 130, 246, 0.5);
            color: #60a5fa;
        }
    </style>
</head>
<body class="bg-slate-950 text-slate-100 font-sans min-h-screen">

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        <!-- Header -->
        <header class="flex flex-col md:flex-row justify-between items-start md:items-center mb-8 gap-4">
            <div>
                <h1 class="text-4xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-emerald-400 tracking-tight">
                    Microgreens Monitor
                </h1>
                <p class="text-slate-200 mt-1 font-semibold text-lg">Bangalore, Broccoli, Tissue Substrate Data</p>
                <p class="text-slate-500 text-sm italic">Environmental Intelligence System</p>
            </div>
            <div class="flex flex-col items-end gap-2">
                <div id="status-badge" class="px-4 py-1.5 rounded-full text-xs font-bold bg-slate-900 text-slate-500 border border-slate-800 animate-pulse">
                    Connecting to Firebase...
                </div>
                <div id="live-indicator" class="hidden flex items-center gap-2 text-[10px] font-bold text-emerald-500 uppercase">
                    <span class="relative flex h-2 w-2">
                        <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                        <span class="relative inline-flex rounded-full h-2 w-2 bg-emerald-500"></span>
                    </span>
                    Live Sync Active
                </div>
            </div>
        </header>

        <!-- Filters & Stats Grid -->
        <div class="flex flex-col md:flex-row gap-6 mb-8">
            <!-- Filter Controls -->
            <div class="glass-card p-4 rounded-2xl shadow-xl flex flex-col justify-center gap-3 min-w-[200px]">
                <p class="text-[10px] font-bold text-slate-500 uppercase tracking-widest px-2">Timeline Filter</p>
                <div class="flex flex-col gap-2" id="filter-container">
                    <button onclick="setFilter('10m')" data-filter="10m" class="filter-btn text-left px-3 py-2 rounded-lg text-sm border border-transparent hover:bg-white/5 transition-all">Last 10 Minutes</button>
                    <button onclick="setFilter('1d')" data-filter="1d" class="filter-btn text-left px-3 py-2 rounded-lg text-sm border border-transparent hover:bg-white/5 transition-all">Last 24 Hours</button>
                    <button onclick="setFilter('all')" data-filter="all" class="filter-btn-active filter-btn text-left px-3 py-2 rounded-lg text-sm border border-transparent hover:bg-white/5 transition-all">All Time</button>
                </div>
            </div>

            <!-- Dynamic Stats -->
            <div id="stats-grid" class="flex-grow grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4">
                <div class="glass-card p-6 rounded-2xl flex items-center justify-center">
                    <p class="text-slate-600 animate-pulse italic text-sm">Syncing latest metrics...</p>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
            <!-- Chart Section -->
            <div class="lg:col-span-2 glass-card p-6 rounded-3xl shadow-2xl relative overflow-hidden">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="text-xl font-bold text-white">Temperature Analytics</h3>
                        <p id="chart-subtitle" class="text-xs text-slate-500 font-mono tracking-tight">Monitoring thermal stability in tissue substrate</p>
                    </div>
                </div>
                <div class="h-80 w-full">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <!-- Activity Log -->
            <div class="glass-card p-6 rounded-3xl shadow-2xl flex flex-col h-[450px]">
                <h3 class="text-xl font-bold text-white mb-4">System Event Log</h3>
                <div id="log-container" class="flex-grow space-y-3 text-[11px] font-mono overflow-y-auto pr-2 custom-scrollbar">
                    <div class="text-slate-600">Waiting for Firebase handshake...</div>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getDatabase, ref, onValue } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyBnuEebPEA9rY5ILG8F3zRVNzQj9xfxm-Y",
            authDomain: "microgreens-ae75c.firebaseapp.com",
            databaseURL: "https://microgreens-ae75c-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "microgreens-ae75c",
            storageBucket: "microgreens-ae75c.firebasestorage.app",
            messagingSenderId: "134579315817",
            appId: "1:134579315817:web:3b5387c5ad92e254496ef8"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // Use 'logs' node as shown in the data structure
        const logsRef = ref(db, 'logs'); 

        let currentFilter = 'all';
        let allDataPoints = [];
        const cardElements = {};

        // DOM Elements
        const statusBadge = document.getElementById('status-badge');
        const liveIndicator = document.getElementById('live-indicator');
        const logContainer = document.getElementById('log-container');
        const statsGrid = document.getElementById('stats-grid');
        const chartSubtitle = document.getElementById('chart-subtitle');

        // Initialize Chart
        const ctx = document.getElementById('tempChart').getContext('2d');
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(59, 130, 246, 0.3)');
        gradient.addColorStop(1, 'rgba(59, 130, 246, 0)');

        const tempChart = new Chart(ctx, {
            type: 'line',
            data: { labels: [], datasets: [{ 
                label: 'Temperature (째C)', 
                data: [], 
                borderColor: '#60a5fa', 
                borderWidth: 2, 
                backgroundColor: gradient, 
                fill: true, 
                tension: 0.4, 
                pointRadius: 2,
                pointHoverRadius: 6
            }]},
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { 
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `Temp: ${context.parsed.y}째C`;
                            }
                        }
                    }
                },
                scales: {
                    y: { 
                        grid: { color: 'rgba(255,255,255,0.05)' }, 
                        ticks: { color: '#475569' },
                        title: { display: true, text: 'Temperature (째C)', color: '#475569', font: { size: 10 } }
                    },
                    x: { grid: { display: false }, ticks: { color: '#475569', maxRotation: 0, autoSkip: true, maxTicksLimit: 10 } }
                }
            }
        });

        window.setFilter = (filter) => {
            currentFilter = filter;
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.classList.remove('filter-btn-active');
                if(btn.dataset.filter === filter) btn.classList.add('filter-btn-active');
            });
            updateChartDisplay();
        };

        function addLog(msg, colorClass = 'text-slate-400') {
            const time = new Date().toLocaleTimeString([], { hour12: false });
            const entry = document.createElement('div');
            entry.className = `${colorClass} border-b border-slate-800/50 pb-1`;
            entry.innerHTML = `<span class="text-slate-600">[${time}]</span> ${msg}`;
            logContainer.prepend(entry);
            if(logContainer.children.length > 50) logContainer.lastChild.remove();
        }

        function updateStatCard(key, value) {
            const displayKey = key.toUpperCase();
            if (!cardElements[key]) {
                const card = document.createElement('div');
                card.className = "glass-card p-6 rounded-2xl shadow-xl border-l-4 border-blue-500/50";
                card.innerHTML = `<p class="text-slate-500 text-[10px] font-bold mb-1 tracking-widest">${displayKey}</p><h2 id="val-${key}" class="text-3xl font-black text-white">--</h2>`;
                statsGrid.appendChild(card);
                cardElements[key] = document.getElementById(`val-${key}`);
                if (statsGrid.children[0]?.innerText.includes("Syncing")) statsGrid.children[0].remove();
            }
            cardElements[key].innerText = value;
        }

        function updateChartDisplay() {
            const now = Date.now();
            let filtered = [];

            if (currentFilter === '10m') {
                const limit = now - (10 * 60 * 1000);
                filtered = allDataPoints.filter(d => d.timestamp >= limit);
            } else if (currentFilter === '1d') {
                const limit = now - (24 * 60 * 60 * 1000);
                filtered = allDataPoints.filter(d => d.timestamp >= limit);
            } else {
                filtered = allDataPoints;
            }

            tempChart.data.labels = filtered.map(d => new Date(d.timestamp).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit', second:'2-digit'}));
            tempChart.data.datasets[0].data = filtered.map(d => d.value);
            tempChart.update('none');
        }

        // Single Listener for the 'logs' node
        onValue(logsRef, (snapshot) => {
            const data = snapshot.val();
            if (!data) return;

            const rawPoints = Object.entries(data).map(([key, val]) => ({
                timestamp: val.timestamp || 0,
                value: val.count_value ?? val.value ?? 0
            }));

            allDataPoints = rawPoints.sort((a, b) => a.timestamp - b.timestamp);

            if (allDataPoints.length > 0) {
                const latest = allDataPoints[allDataPoints.length - 1];
                updateStatCard('Current Temperature', `${latest.value}째C`);
                updateStatCard('Logs Captured', allDataPoints.length);
                
                statusBadge.innerText = "System Online";
                statusBadge.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-emerald-500/10 text-emerald-400 border border-emerald-500/20 animate-none";
                liveIndicator.classList.remove('hidden');
            }

            updateChartDisplay();
            addLog(`Telemetry sync: ${allDataPoints.length} points mapped to Bangalore node.`);
        }, (error) => {
            console.error(error);
            statusBadge.innerText = "Connection Error";
            statusBadge.className = "px-4 py-1.5 rounded-full text-xs font-bold bg-red-500/10 text-red-400 border border-red-500/20 animate-none";
        });
    </script>
</body>
</html>
